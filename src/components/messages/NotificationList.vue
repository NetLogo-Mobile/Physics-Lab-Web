<template>
  <infiniteScroll :has-more="!noMore" :initial-items="items" @load="handleLoad">
    <template #default="slotProps">
      <div v-for="item in slotProps.items as NotificationItem[]" :key="item.id">
        <Notification :notification="item" />
        <n-divider style="margin: 0" />
      </div>
    </template>
  </infiniteScroll>
</template>

<script setup lang="ts">
import { ref } from "vue";
import Notification from "./NotificationItem.vue";
import { getData } from "../../services/api/getData.ts";
import Emitter from "../../services/eventEmitter";
import InfiniteScroll from "../utils/infiniteScroll.vue";

interface NotificationItem {
  id: number;
  msg_title: string;
  msg: string;
  msg_type: number;
  category: string;
  tid: string;
  name: string;
  uid: string;
}

const items = ref<NotificationItem[]>([]);
const loading = ref(false);
let skip = 0;
const noMore = ref(false);
let templates: any = [
  {
    ID: "5c90f172a2409b51dc5cb945",
    Identifier: "Letter-Test",
    CategoryID: 1,
    Management: false,
    Subject: {
      Chinese: "一封测试邮件 {Users}",
      English: "A letter for test {Users}",
      ChineseTraditional: "一封測試郵件 {Users}",
      German: "Ein Brief für den Test {Benutzer}",
      French: "Une lettre pour le test {Utilisateurs}",
      Japanese: "テスト用の手紙{Users}",
      Italian: "Una lettera per il test {Utenti}",
      Polish: null,
      Spanish: null,
      Ukrainian: null,
    },
    Content: {
      Chinese: "这是一封测试邮件，用于测试所有功能。{Users}",
      English: "This is a letter for test to test every features. {Users}",
      ChineseTraditional: "這是一封測試郵件，用於測試所有功能。 {Users}",
      German: "Dies ist ein Testbrief zum Testen aller Funktionen. {Benutzer}",
      French:
        "Ceci est une lettre de test pour tester toutes les fonctionnalités. {Utilisateurs}",
      Japanese:
        "これはすべての機能をテストするためのテスト用の手紙です。 {ユーザー}",
      Italian:
        "Questa è una lettera per test per testare tutte le funzionalità. {} utenti",
      Polish: null,
      Spanish: null,
      Ukrainian: null,
    },
    Description: null,
    Bonuses: {
      Fragment: 1,
    },
    Action: null,
    CombineLimit: 0,
    AvailableFrom: 1546322400000,
    AvailableUntil: 1893477600000,
    Push: 0,
  },
  {
    ID: "5c9114e9ce50092ed4453fd5",
    Identifier: "Attention-Followed",
    CategoryID: 2,
    Management: false,
    Subject: {
      Chinese: "新的关注者！",
      English: "New follower!",
      ChineseTraditional: "新的關注者！",
      German: "Neuer Anhänger",
      French: "Nouveau disciple!",
      Japanese: "新しいフォロワー！",
      Italian: "Nuovo follower!",
      Polish: "Nowy obserwujący!",
      Spanish: "¡Nuevo seguidor!",
      Ukrainian: "Новий підписник!",
    },
    Content: {
      Chinese: "{Users} 关注了你。",
      English: "{Users} followed you.",
      ChineseTraditional: "{Users} 關注了你。",
      German: "{Users} ist dir gefolgt.",
      French: "{Users} vous a suivi.",
      Japanese: "{Users} さんがあなたをフォローしました。",
      Italian: "{Users} ti hanno seguito.",
      Polish: "{Users} obserwują Cię.",
      Spanish: "{Users} te siguió.",
      Ukrainian: "{Users} підписалися на вас.",
    },
    Description: null,
    Bonuses: null,
    Action: null,
    CombineLimit: 10,
    AvailableFrom: 1546322400000,
    AvailableUntil: 1893477600000,
    Push: 0,
  },
];

const { notificationTypeIndexOfUI } = defineProps([
  "notificationTypeIndexOfUI",
]);

function convertCategoryIDToUIIndex(n: number) {
  return n === 2 ? 3 : n === 3 ? 2 : n;
}

function convertUIIndexToCategoryID(n: number) {
  return n === 3 ? 2 : n === 2 ? 3 : n;
}

function fillInTemplate(data: string, message: any) {
  const re = data
    .replace(
      /{Users}/g,
      message.Users.map(
        (user: any, index: any) =>
          `<user=${user}>${message.UserNames[index]}</user>`,
      ).join(" "),
    )
    .replace(
      /{Experiment}/g,
      message.Fields?.Discussion
        ? `<discussion=${message.Fields?.DiscussionID}>${message.Fields?.Discussion}</discussion>`
        : `<experiment${message.Fields?.ExperimentID}>${message.Fields?.Experiment}</experiment>`,
    )
    .replace(/{\$Content}/g, message.Fields.Content)
    .replace(/{\$TargetName}/g, localStorage.getItem("nickName") || "朋友")
    .replace(/{\$Until}/g, message.Fields.Unitl)
    .replace(/{\$Editor}/g, message.Fields.Editor)
    .replace(/{\$Gold}/g, message.Numbers?.Gold)
    .replace(/undefined/g, "");
  return re;
}

// 处理加载事件
const handleLoad = async (noTemplates = true) => {
  if (loading.value) return;
  if (noMore.value) return;
  loading.value = true;
  try {
    const getMessagesResponse = await getData("/Messages/GetMessages", {
      CategoryID: convertUIIndexToCategoryID(notificationTypeIndexOfUI),
      Take: 20,
      Skip: skip,
      NoTemplates: noTemplates,
    });

    if (!noTemplates) {
      templates = getMessagesResponse.Data.Templates;
    }

    const messages = getMessagesResponse.Data.Messages;

    if (messages.length === 0) {
      noMore.value = true;
      Emitter.emit("warning", "没有更多了", 2);
    }

    const defaultItems = messages.map((message: any) => {
      const template = templates.find((t: any) => t.ID === message.TemplateID);
      return {
        id: message.ID,
        msg_title: fillInTemplate(template.Subject.Chinese, message),
        msg: fillInTemplate(template.Content.Chinese, message),
        msg_type: convertCategoryIDToUIIndex(message.CategoryID),
        category: message.Fields?.User
          ? "User"
          : message.Fields?.Discussion
            ? "Discussion"
            : "Experiment",
        tid:
          message.Fields?.UserID ||
          message.Fields?.DiscussionID ||
          message.Fields?.ExperimentID,
        name:
          message.Fields?.Discussion ||
          message.Fields?.Experiment ||
          message.Fields?.User,
        uid: message.Users[0],
      };
    });

    items.value = [...items.value, ...defaultItems];
    loading.value = false;
    skip += 20;
  } catch (error) {
    Emitter.emit("error", String(error), 5);
  }
};

handleLoad(false);
</script>

<style scoped>
.text {
  text-align: center;
  color: #888;
}
</style>
