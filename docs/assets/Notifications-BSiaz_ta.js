import{d as M,n as H,q as $,b as F,c as w,f as r,u as A,s as z,t as P,e as s,_ as L,g as j,v as V,r as k,j as q,w as p,i as Q,F as B,h as R,x as W,E as K,H as X,m as Y}from"./index-IgtzcjKR.js";const Z={class:"notification_container"},ee=["src"],te=["innerHTML"],ne={id:"notification_message",class:"notification_message"},ie={id:"notification_icon",class:"notification_icon"},se=["src"],ae={id:"notification_text",class:"notification_text"},re=M({__name:"NotificationItem",props:{avatar_url:String,msg:String,msg_title:String,msg_type:Number,tid:String,category:String,name:String,uid:String},setup(i){const l=i,c=H(()=>{switch(l.msg_type){case 1:return"/assets/icons/notifications_system.png";case 2:return"/assets/icons/notifications_comments.png";case 3:return"/assets/icons/notifications_followers.png";case 4:return"/assets/icons/notifications_projects.png";case 5:return"/assets/icons/notifications_admin.png";default:return""}});function d(){l.msg_type===2&&window.open(`/Comments/${l.category}/${l.tid}/${l.name}`,"_self")}return(_,v)=>{const y=$("n-ellipsis");return F(),w("div",Z,[r("div",{class:"img",onClick:v[0]||(v[0]=N=>A(z)(i.uid))},[r("img",{src:i.avatar_url,id:"avatar"},null,8,ee)]),r("div",{id:"notification",class:"notification",onClick:d},[r("div",{id:"notification_title",class:"notification_title",innerHTML:A(P)(i.msg_title,!0)},null,8,te),r("div",ne,[r("div",ie,[r("img",{src:c.value,id:"notification_icon"},null,8,se)]),r("div",ae,[s(y,{"expand-trigger":"click","line-clamp":"2",tooltip:!1,innerHTML:A(P)(i.msg,!0)},null,8,["innerHTML"])])])])])}}}),oe=L(re,[["__scopeId","data-v-5fd8805a"]]);let g=JSON.parse(localStorage.getItem("userIDAndAvartarIDMap"))||{};async function le(i,l=!0){let c=0;if(l&&g[i]&&Math.abs(Date.now()-g[i][1])<72*60*60*1e3&&g[i][0]!==void 0&&g[i][0]!==null)c=g[i][0];else try{const _=new Promise((y,N)=>{setTimeout(()=>N(new Error("请求超时")),3e3)});c=(await Promise.race([j("/Users/GetUser",{ID:i}),_])).Data.User.Avatar,g[i]=[c,Date.now()],localStorage.setItem("userIDAndAvartarIDMap",JSON.stringify(g))}catch(_){return console.error("获取头像失败",_),"/assets/user/default-avatar.png"}return V({ID:i,Avatar:c})}function ce(){localStorage.setItem("userIDAndAvartarIDMap",JSON.stringify(g))}const de={key:0,class:"text"},ue=M({__name:"NotificationList",props:["notificationTypeIndexOfUI","height"],setup(i){const l=k([]),c=k(!1);let d=0;const _=k(!1);let v=[{ID:"5c90f172a2409b51dc5cb945",Identifier:"Letter-Test",CategoryID:1,Management:!1,Subject:{Chinese:"一封测试邮件 {Users}",English:"A letter for test {Users}",ChineseTraditional:"一封測試郵件 {Users}",German:"Ein Brief für den Test {Benutzer}",French:"Une lettre pour le test {Utilisateurs}",Japanese:"テスト用の手紙{Users}",Italian:"Una lettera per il test {Utenti}",Polish:null,Spanish:null,Ukrainian:null},Content:{Chinese:"这是一封测试邮件，用于测试所有功能。{Users}",English:"This is a letter for test to test every features. {Users}",ChineseTraditional:"這是一封測試郵件，用於測試所有功能。 {Users}",German:"Dies ist ein Testbrief zum Testen aller Funktionen. {Benutzer}",French:"Ceci est une lettre de test pour tester toutes les fonctionnalités. {Utilisateurs}",Japanese:"これはすべての機能をテストするためのテスト用の手紙です。 {ユーザー}",Italian:"Questa è una lettera per test per testare tutte le funzionalità. {} utenti",Polish:null,Spanish:null,Ukrainian:null},Description:null,Bonuses:{Fragment:1},Action:null,CombineLimit:0,AvailableFrom:15463224e5,AvailableUntil:18934776e5,Push:0},{ID:"5c9114e9ce50092ed4453fd5",Identifier:"Attention-Followed",CategoryID:2,Management:!1,Subject:{Chinese:"新的关注者！",English:"New follower!",ChineseTraditional:"新的關注者！",German:"Neuer Anhänger",French:"Nouveau disciple!",Japanese:"新しいフォロワー！",Italian:"Nuovo follower!",Polish:"Nowy obserwujący!",Spanish:"¡Nuevo seguidor!",Ukrainian:"Новий підписник!"},Content:{Chinese:"{Users} 关注了你。",English:"{Users} followed you.",ChineseTraditional:"{Users} 關注了你。",German:"{Users} ist dir gefolgt.",French:"{Users} vous a suivi.",Japanese:"{Users} さんがあなたをフォローしました。",Italian:"{Users} ti hanno seguito.",Polish:"{Users} obserwują Cię.",Spanish:"{Users} te siguió.",Ukrainian:"{Users} підписалися на вас."},Description:null,Bonuses:null,Action:null,CombineLimit:10,AvailableFrom:15463224e5,AvailableUntil:18934776e5,Push:0}];function y(o){return o===2?3:o===3?2:o}function N(o){return o===3?2:o===2?3:o}function S(o,n){var e,a,t,u,f,m;return o.replace(/{Users}/g,n.Users.map((U,I)=>`<user=${U}>${n.UserNames[I]}</user>`).join(" ")).replace(/{Experiment}/g,(e=n.Fields)!=null&&e.Discussion?`<discussion=${(a=n.Fields)==null?void 0:a.DiscussionID}>${(t=n.Fields)==null?void 0:t.Discussion}</discussion>`:`<experiment${(u=n.Fields)==null?void 0:u.ExperimentID}>${(f=n.Fields)==null?void 0:f.Experiment}</experiment>`).replace(/{\$Content}/g,n.Fields.Content).replace(/{\$TargetName}/g,localStorage.getItem("nickName")||"朋友").replace(/{\$Until}/g,n.Fields.Unitl).replace(/{\$Editor}/g,n.Fields.Editor).replace(/{\$Gold}/g,(m=n.Numbers)==null?void 0:m.Gold).replace(/undefined/g,"")}async function G(o){const n=o.map(e=>le(e.Users[0],!0)),h=await Promise.all(n);return ce(),o.map((e,a)=>{var u,f,m,U,I,x,T,b;const t=v.find(E=>E.ID===e.TemplateID);return{id:e.ID,avatar_url:y(e.CategoryID)==1?"/assets/messages/Message-Unread.png":h[a],msg_title:S(t.Subject.Chinese,e),msg:S(t.Content.Chinese,e),msg_type:y(e.CategoryID),category:(u=e.Fields)!=null&&u.User?"User":(f=e.Fields)!=null&&f.Discussion?"Discussion":"Experiment",tid:((m=e.Fields)==null?void 0:m.UserID)||((U=e.Fields)==null?void 0:U.DiscussionID)||((I=e.Fields)==null?void 0:I.ExperimentID),name:((x=e.Fields)==null?void 0:x.Discussion)||((T=e.Fields)==null?void 0:T.Experiment)||((b=e.Fields)==null?void 0:b.User),uid:e.Users[0]}})}const O=async(o=!0)=>{if(!c.value&&!_.value){c.value=!0;try{const n=await j("/Messages/GetMessages",{CategoryID:N(i.notificationTypeIndexOfUI),Take:20,Skip:d,NoTemplates:o});o||(v=n.Data.Templates);const h=n.Data.Messages;n.Data.Messages.length===0&&(_.value=!0,K.emit("warning","没有更多了",2));const e=h.map(t=>{var f,m,U,I,x,T,b,E;const u=v.find(J=>J.ID===t.TemplateID);return{id:t.ID,avatar_url:"/assets/user/default-avatar.png",msg_title:S(u.Subject.Chinese,t),msg:S(u.Content.Chinese,t),msg_type:y(t.CategoryID),category:(f=t.Fields)!=null&&f.User?"User":(m=t.Fields)!=null&&m.Discussion?"Discussion":"Experiment",tid:((U=t.Fields)==null?void 0:U.UserID)||((I=t.Fields)==null?void 0:I.DiscussionID)||((x=t.Fields)==null?void 0:x.ExperimentID),name:((T=t.Fields)==null?void 0:T.Discussion)||((b=t.Fields)==null?void 0:b.Experiment)||((E=t.Fields)==null?void 0:E.User),uid:t.Users[0]}});l.value=[...l.value,...e],c.value=!1;const a=await G(h);l.value=l.value.map(t=>{const u=a.find(f=>f.id===t.id);return u?{...t,avatar_url:u.avatar_url}:t}),d+=20}catch(n){console.error("加载消息失败",n)}}};return O(!1),(o,n)=>{const h=$("n-divider"),e=$("n-infinite-scroll");return F(),q(e,{distance:10,onLoad:O,style:W(`height: ${i.height}`)},{default:p(()=>[(F(!0),w(B,null,Q(l.value,a=>(F(),w("div",{key:a.id},[s(oe,{avatar_url:a.avatar_url,msg_title:a.msg_title,msg:a.msg,msg_type:a.msg_type,category:a.category,id:a.id,tid:a.tid,name:a.name,uid:a.uid},null,8,["avatar_url","msg_title","msg","msg_type","category","id","tid","name","uid"]),s(h,{style:{margin:"0"}})]))),128)),c.value&&!_.value?(F(),w("div",de,"加载中...")):R("",!0)]),_:1},8,["style"])}}}),D=L(ue,[["__scopeId","data-v-d4323a12"]]),_e={class:"outer"},fe={class:"item"},pe={class:"item"},me={class:"item"},ge={class:"item"},ve={class:"item"},he={class:"item"},C="calc(100dvh - 150px)",Ue=M({__name:"Notifications",setup(i){return(l,c)=>{const d=$("n-tab-pane"),_=$("n-tabs");return F(),w(B,null,[s(X,null,{default:p(()=>c[0]||(c[0]=[r("h1",null,"通知",-1)])),_:1}),r("main",null,[r("div",_e,[s(_,{type:"line",class:"list",animated:""},{default:p(()=>[s(d,{name:"全部",tab:"全部",style:{padding:"0"}},{default:p(()=>[r("div",fe,[s(D,{notificationTypeIndexOfUI:"0",height:C})])]),_:1}),s(d,{name:"系统消息",tab:"系统消息"},{default:p(()=>[r("div",pe,[s(D,{notificationTypeIndexOfUI:"1",height:C})])]),_:1}),s(d,{name:"回复和评论",tab:"回复和评论"},{default:p(()=>[r("div",me,[s(D,{notificationTypeIndexOfUI:"3",height:C})])]),_:1}),s(d,{name:"关注和粉丝",tab:"关注和粉丝"},{default:p(()=>[r("div",ge,[s(D,{notificationTypeIndexOfUI:"2",height:C})])]),_:1}),s(d,{name:"作品",tab:"作品"},{default:p(()=>[r("div",ve,[s(D,{notificationTypeIndexOfUI:"4",height:C})])]),_:1}),s(d,{name:"管理通知",tab:"管理通知"},{default:p(()=>[r("div",he,[s(D,{notificationTypeIndexOfUI:"5",height:C})])]),_:1})]),_:1})])]),s(Y)],64)}}}),ye=L(Ue,[["__scopeId","data-v-650ee249"]]);export{ye as default};
