import{d as k,n as J,q as b,b as C,c as $,f as r,u as S,s as O,e as i,_ as A,g as P,r as E,j as H,w as _,i as z,F as j,h as V,E as q,H as Q,m as R}from"./index-B-eZ0YOv.js";import{s as W}from"./usercard-CJfEyHAw.js";const K={class:"notification_container"},X=["src"],Y=["innerHTML"],Z={id:"notification_message",class:"notification_message"},ee={id:"notification_icon",class:"notification_icon"},te=["src"],ne={id:"notification_text",class:"notification_text"},se=k({__name:"NotificationItem",props:{avatar_url:String,msg:String,msg_title:String,msg_type:Number,tid:String,category:String,name:String,uid:String},setup(n){const u=n,l=J(()=>{switch(u.msg_type){case 1:return"src/assets/icons/notifications_system.png";case 2:return"src/assets/icons/notifications_comments.png";case 3:return"src/assets/icons/notifications_followers.png";case 4:return"src/assets/icons/notifications_projects.png";case 5:return"src/assets/icons/notifications_admin.png";default:return""}});function c(){u.msg_type===2&&window.open(`/Comments/${u.category}/${u.tid}/${u.name}`,"_self")}return(g,v)=>{const h=b("n-ellipsis");return C(),$("div",K,[r("div",{class:"img",onClick:v[0]||(v[0]=M=>S(W)(n.uid))},[r("img",{src:n.avatar_url,id:"avatar",onerror:"this.src='/src/assets/user/default-avatar.png'"},null,8,X)]),r("div",{id:"notification",class:"notification",onClick:c},[r("div",{id:"notification_title",class:"notification_title",innerHTML:S(O)(n.msg_title,!0)},null,8,Y),r("div",Z,[r("div",ee,[r("img",{src:l.value,id:"notification_icon"},null,8,te)]),r("div",ne,[i(h,{"expand-trigger":"click","line-clamp":"2",tooltip:!1,innerHTML:S(O)(n.msg,!0)},null,8,["innerHTML"])])])])])}}}),ie=A(se,[["__scopeId","data-v-668421e8"]]);let m=JSON.parse(localStorage.getItem("userIDAndAvartarIDMap"))||{};async function ae(n,u=!0){let l=0;if(u&&m[n]&&Math.abs(Date.now()-m[n][1])<72*60*60*1e3&&m[n][0]!==void 0&&m[n][0]!==null)l=m[n][0];else try{const c=new Promise((v,h)=>{setTimeout(()=>h(new Error("请求超时")),3e3)});l=(await Promise.race([P("/Users/GetUser",{ID:n}),c])).Data.User.Avatar,m[n]=[l,Date.now()],localStorage.setItem("userIDAndAvartarIDMap",JSON.stringify(m))}catch(c){return console.error("获取头像失败",c),"/src/assets/user/default-avatar.png"}return l===0?"/src/assets/user/default-avatar.png":`http://physics-static-cn.turtlesim.com:80/users/avatars/${n.slice(0,4)}/${n.slice(4,6)}/${n.slice(6,8)}/${n.slice(8,24)}/${l}.jpg!small.round`}function re(){localStorage.setItem("userIDAndAvartarIDMap",JSON.stringify(m))}const oe={key:0,class:"text"},le=k({__name:"NotificationList",props:["notificationTypeIndexOfUI"],setup(n){const u=E([]),l=E(!1);let c=0;const g=E(!1);let v=[{ID:"5c90f172a2409b51dc5cb945",Identifier:"Letter-Test",CategoryID:1,Management:!1,Subject:{Chinese:"一封测试邮件 {Users}",English:"A letter for test {Users}",ChineseTraditional:"一封測試郵件 {Users}",German:"Ein Brief für den Test {Benutzer}",French:"Une lettre pour le test {Utilisateurs}",Japanese:"テスト用の手紙{Users}",Italian:"Una lettera per il test {Utenti}",Polish:null,Spanish:null,Ukrainian:null},Content:{Chinese:"这是一封测试邮件，用于测试所有功能。{Users}",English:"This is a letter for test to test every features. {Users}",ChineseTraditional:"這是一封測試郵件，用於測試所有功能。 {Users}",German:"Dies ist ein Testbrief zum Testen aller Funktionen. {Benutzer}",French:"Ceci est une lettre de test pour tester toutes les fonctionnalités. {Utilisateurs}",Japanese:"これはすべての機能をテストするためのテスト用の手紙です。 {ユーザー}",Italian:"Questa è una lettera per test per testare tutte le funzionalità. {} utenti",Polish:null,Spanish:null,Ukrainian:null},Description:null,Bonuses:{Fragment:1},Action:null,CombineLimit:0,AvailableFrom:15463224e5,AvailableUntil:18934776e5,Push:0},{ID:"5c9114e9ce50092ed4453fd5",Identifier:"Attention-Followed",CategoryID:2,Management:!1,Subject:{Chinese:"新的关注者！",English:"New follower!",ChineseTraditional:"新的關注者！",German:"Neuer Anhänger",French:"Nouveau disciple!",Japanese:"新しいフォロワー！",Italian:"Nuovo follower!",Polish:"Nowy obserwujący!",Spanish:"¡Nuevo seguidor!",Ukrainian:"Новий підписник!"},Content:{Chinese:"{Users} 关注了你。",English:"{Users} followed you.",ChineseTraditional:"{Users} 關注了你。",German:"{Users} ist dir gefolgt.",French:"{Users} vous a suivi.",Japanese:"{Users} さんがあなたをフォローしました。",Italian:"{Users} ti hanno seguito.",Polish:"{Users} obserwują Cię.",Spanish:"{Users} te siguió.",Ukrainian:"{Users} підписалися на вас."},Description:null,Bonuses:null,Action:null,CombineLimit:10,AvailableFrom:15463224e5,AvailableUntil:18934776e5,Push:0}];function h(o){return o===2?3:o===3?2:o}function M(o){return o===3?2:o===2?3:o}function w(o,s){var e,a,t,d,p,f;return o.replace(/{Users}/g,s.Users.map((I,y)=>`<user=${I}>${s.UserNames[y]}</user>`).join(" ")).replace(/{Experiment}/g,(e=s.Fields)!=null&&e.Discussion?`<discussion=${(a=s.Fields)==null?void 0:a.DiscussionID}>${(t=s.Fields)==null?void 0:t.Discussion}</discussion>`:`<experiment${(d=s.Fields)==null?void 0:d.ExperimentID}>${(p=s.Fields)==null?void 0:p.Experiment}</experiment>`).replace(/{\$Content}/g,s.Fields.Content).replace(/{\$TargetName}/g,localStorage.getItem("nickName")||"朋友").replace(/{\$Until}/g,s.Fields.Unitl).replace(/{\$Editor}/g,s.Fields.Editor).replace(/{\$Gold}/g,(f=s.Numbers)==null?void 0:f.Gold).replace(/undefined/g,"")}async function B(o){const s=o.map(e=>ae(e.Users[0],!0)),U=await Promise.all(s);return re(),o.map((e,a)=>{var d,p,f,I,y,F,x,T;const t=v.find(N=>N.ID===e.TemplateID);return{id:e.ID,avatar_url:h(e.CategoryID)==1?"/src/assets/messages/Message-Unread.png":U[a],msg_title:w(t.Subject.Chinese,e),msg:w(t.Content.Chinese,e),msg_type:h(e.CategoryID),category:(d=e.Fields)!=null&&d.User?"User":(p=e.Fields)!=null&&p.Discussion?"Discussion":"Experiment",tid:((f=e.Fields)==null?void 0:f.UserID)||((I=e.Fields)==null?void 0:I.DiscussionID)||((y=e.Fields)==null?void 0:y.ExperimentID),name:((F=e.Fields)==null?void 0:F.Discussion)||((x=e.Fields)==null?void 0:x.Experiment)||((T=e.Fields)==null?void 0:T.User),uid:e.Users[0]}})}const L=async(o=!0)=>{if(!l.value&&!g.value){l.value=!0;try{const s=await P("/Messages/GetMessages",{CategoryID:M(n.notificationTypeIndexOfUI),Take:20,Skip:c,NoTemplates:o});o||(v=s.Data.Templates);const U=s.Data.Messages;s.Data.Messages.length===0&&(g.value=!0,q.emit("warning","没有更多了",2));const e=U.map(t=>{var p,f,I,y,F,x,T,N;const d=v.find(G=>G.ID===t.TemplateID);return{id:t.ID,avatar_url:"/src/assets/user/default-avatar.png",msg_title:w(d.Subject.Chinese,t),msg:w(d.Content.Chinese,t),msg_type:h(t.CategoryID),category:(p=t.Fields)!=null&&p.User?"User":(f=t.Fields)!=null&&f.Discussion?"Discussion":"Experiment",tid:((I=t.Fields)==null?void 0:I.UserID)||((y=t.Fields)==null?void 0:y.DiscussionID)||((F=t.Fields)==null?void 0:F.ExperimentID),name:((x=t.Fields)==null?void 0:x.Discussion)||((T=t.Fields)==null?void 0:T.Experiment)||((N=t.Fields)==null?void 0:N.User),uid:t.Users[0]}});u.value=[...u.value,...e],l.value=!1;const a=await B(U);u.value=u.value.map(t=>{const d=a.find(p=>p.id===t.id);return d?{...t,avatar_url:d.avatar_url}:t}),c+=20}catch(s){console.error("加载消息失败",s)}}};return L(!1),(o,s)=>{const U=b("n-divider"),e=b("n-infinite-scroll");return C(),H(e,{distance:10,onLoad:L,style:{height:"100%"}},{default:_(()=>[(C(!0),$(j,null,z(u.value,a=>(C(),$("div",{key:a.id},[i(ie,{avatar_url:a.avatar_url,msg_title:a.msg_title,msg:a.msg,msg_type:a.msg_type,category:a.category,id:a.id,tid:a.tid,name:a.name,uid:a.uid},null,8,["avatar_url","msg_title","msg","msg_type","category","id","tid","name","uid"]),i(U,{style:{margin:"0"}})]))),128)),l.value&&!g.value?(C(),$("div",oe,"加载中...")):V("",!0)]),_:1})}}}),D=A(le,[["__scopeId","data-v-e1367564"]]),ce={class:"outer"},ue={class:"item"},de={class:"item"},pe={class:"item"},_e={class:"item"},fe={class:"item"},me={class:"item"},ge=k({__name:"Notifications",setup(n){return(u,l)=>{const c=b("n-tab-pane"),g=b("n-tabs");return C(),$(j,null,[i(Q,null,{default:_(()=>l[0]||(l[0]=[r("h1",null,"通知",-1)])),_:1}),r("main",null,[r("div",ce,[i(g,{type:"line",class:"list",animated:""},{default:_(()=>[i(c,{name:"全部",tab:"全部",style:{padding:"0"}},{default:_(()=>[r("div",ue,[i(D,{notificationTypeIndexOfUI:"0"})])]),_:1}),i(c,{name:"系统消息",tab:"系统消息"},{default:_(()=>[r("div",de,[i(D,{notificationTypeIndexOfUI:"1"})])]),_:1}),i(c,{name:"回复和评论",tab:"回复和评论"},{default:_(()=>[r("div",pe,[i(D,{notificationTypeIndexOfUI:"3"})])]),_:1}),i(c,{name:"关注和粉丝",tab:"关注和粉丝"},{default:_(()=>[r("div",_e,[i(D,{notificationTypeIndexOfUI:"2"})])]),_:1}),i(c,{name:"作品",tab:"作品"},{default:_(()=>[r("div",fe,[i(D,{notificationTypeIndexOfUI:"4"})])]),_:1}),i(c,{name:"管理通知",tab:"管理通知"},{default:_(()=>[r("div",me,[i(D,{notificationTypeIndexOfUI:"5"})])]),_:1})]),_:1})])]),i(R)],64)}}}),Ue=A(ge,[["__scopeId","data-v-524f210f"]]);export{Ue as default};
